<div style="position: fixed;">
    <p>FPS: <span id="fps-counter">-</span></p>
    <p>Objects: <span id="objects-count">-</span></p>
    <p>Total Momentum: <span id="total-momentum">-</span></p>
</div>
<canvas id="canvas"></canvas>
<script>
    let lastFrameTime = Date.now();
    let currentFrameTime = Date.now();
    let fpsAccum = 0;
    let totalFps = 0;
    let worldSpeed = 10;
    let test1 = 0;

    const objectsCount = document.getElementById('objects-count');
    const totalMomentum = document.getElementById('total-momentum');
    const fpsCounter = document.getElementById('fps-counter');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 1500;
    canvas.height = 700;
    /*
    const spaceObjects = [
        { position: { x: 700, y: 350 }, moment: { x: 16, y: 0 }, mass: 1024 }, // neptune
      { position: { x: 700, y: 100 }, moment: { x: 12, y: 0 }, mass: 868 }, // uranus
      { position: { x: 200, y: 300 }, moment: { x: 3, y: 0 }, mass: 5683 }, // saturn
      { position: { x: 800, y: 400 }, moment: { x: 2, y: 0 }, mass: 18981 }, // jupiter
      { position: { x: 200, y: 500 }, moment: { x: 0, y: 2 }, mass: 6 }, // mars
      { position: { x: 900, y: 600 }, moment: { x: 0, y: 2 }, mass: 59 }, // arth
      { position: { x: 100, y: 700 }, moment: { x: 7, y: 0 }, mass: 48 }, // venus
      { position: { x: 720, y: 300 }, moment: { x: 24, y: 0 }, mass: 3 }, // mercury
      { position: { x: 740, y: 350 }, moment: { x: 0, y: 0 }, mass: 19891000 }, // the sun
    ];*/


    let spaceObjects = [];

    const distanceBetween = 15;
    for (let i = distanceBetween; i < canvas.width; i += distanceBetween) {
        for (let j = distanceBetween; j < canvas.height; j += distanceBetween) {
            spaceObjects.push({
                prevPosition: {x: i, y: j},
                position: {x: i, y: j},
                moment: {x: 0, y: 0},
                mass: Math.random() * 2000000,
                //mass: 10000,
                color: {g: Math.floor(Math.random() * 200), b: Math.floor(Math.random() * 200)}
            });
        }
    }

    const drawSpaceObjects = () => {
        const debugNow = Date.now();
        for (let i = 0; i < spaceObjects.length; i++) {
            const x = spaceObjects[i].position.x;
            const y = spaceObjects[i].position.y;
            const size = 6;

            const color = Math.min(255, Math.sqrt(spaceObjects[i].moment.x ** 2 + spaceObjects[i].moment.y ** 2) / 20 * 255);
            //requestAnimationFrame(() => {
            ctx.strokeStyle = ctx.fillStyle = 'rgb(' + color + ', ' + spaceObjects[i].color.g + ', ' + spaceObjects[i].color.b + ')';

            ctx.lineWidth = 6;
            ctx.beginPath();
            ctx.moveTo(spaceObjects[i].prevPosition.x - size / 2, spaceObjects[i].prevPosition.y - size / 2);
            ctx.lineTo(x - size / 2, y - size / 2);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(x - size / 2, y - size / 2, size / 2, 0, 2 * Math.PI);
            ctx.fill();
            //});
        }
        console.log('drawSpaceObjects: ' + (Date.now() - debugNow) + 'ms');
    };

    const updateSpaceObjectsPosition = () => {
        const debugNow = Date.now();
        for (let i = 0; i < spaceObjects.length; i++) {
            spaceObjects[i].prevPosition.x = spaceObjects[i].position.x;
            spaceObjects[i].prevPosition.y = spaceObjects[i].position.y;
            spaceObjects[i].position.x += spaceObjects[i].moment.x;
            spaceObjects[i].position.y += spaceObjects[i].moment.y;
        }
        console.log('updateSpaceObjectsPosition: ' + (Date.now() - debugNow) + 'ms');
    };

    const updateSpaceObjectsMoment = () => {
        const debugNow = Date.now();

        for (let i = 0; i < spaceObjects.length; i++) {
            const rootObject = spaceObjects[i];

            let resultVector = {x: 0, y: 0};

            for (let j = 0; j < spaceObjects.length; j++) {
                if (i === j) continue;
                const dy = rootObject.position.y - spaceObjects[j].position.y;
                const dx = rootObject.position.x - spaceObjects[j].position.x;

                const distance = Math.sqrt(dy * dy + dx * dx);
                let F = rootObject.mass * spaceObjects[j].mass / (distance * distance); // 1 newton law
                if (F > 100000) F = 100000;

                let a = F / rootObject.mass; // 2 newton law
                a *= 0.1;

                const x = (dx === 0 || !isFinite(dx)) ? 0 : dx / Math.max(Math.abs(dy), Math.abs(dx));
                const y = (dy === 0 || !isFinite(dy)) ? 0 : dy / Math.max(Math.abs(dy), Math.abs(dx));

                resultVector.x += -a * x;
                resultVector.y += -a * y;

                //rootObjectVectors.push({ y: -a * y, x: -a * x });
            }
            //let resultVector = rootObjectVectors.reduce((acc, vector) => ({x: vector.x + acc.x, y: vector.y + acc.y}), { x: 0, y: 0 });
            resultVector = {y: resultVector.y / spaceObjects.length, x: resultVector.x / spaceObjects.length};

            rootObject.moment.x += resultVector.x;
            rootObject.moment.y += resultVector.y;
        }

        console.log('updateSpaceObjectsMoment: ' + (Date.now() - debugNow) + 'ms');
    };

    const clearObjects = () => {
        for (let i = 0; i < spaceObjects.length; i++) {
            if (spaceObjects[i].position.x < -1000 || spaceObjects[i].position.y < -1000
                || spaceObjects[i].position.x > 3000 || spaceObjects[i].position.y > 3000) {
                spaceObjects = spaceObjects.filter((_, index) => index !== i);
            }
        }
    };

    const drawMap = () => {
        ctx.fillStyle = 'rgba(255,255,255, 1.00)';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    };

    setInterval(() => {
        currentFrameTime = Date.now();
        const deltaFrameTime = currentFrameTime - lastFrameTime

        lastFrameTime = currentFrameTime;
        totalFps += deltaFrameTime;

        if (totalFps > 1000) {
            fpsCounter.innerHTML = fpsAccum;
            fpsAccum = 0;
            totalFps = 0;
        } else {
            fpsAccum++;
        }

        test1++;
        if (test1 > worldSpeed) {
            test1 = 0;
            return;
        }

        objectsCount.innerHTML = spaceObjects.length;
        totalMomentum.innerHTML = spaceObjects.reduce((acc, object) => acc + Math.sqrt(object.moment.x ** 2 + object.moment.y ** 2), 0);
        clearObjects();
        drawMap();
        updateSpaceObjectsMoment();
        updateSpaceObjectsPosition();
        drawSpaceObjects();
    }, 0);

    document.addEventListener('keyup', e => {
        if (e.keyCode === 32) {

        }
    });

    canvas.addEventListener('mouseup', e => {
        const x = e.clientX;
        const y = e.clientY;

        spaceObjects.push({
            prevPosition: {x: x, y: y},
            position: {x: x, y: y},
            moment: {x: 0, y: 0},
            //mass: Math.random() * 2000000,
            mass: 1000000000000,
            color: {g: Math.floor(Math.random() * 200), b: Math.floor(Math.random() * 200)}
        });
        e.clientX
        e.clientY
    });
</script>